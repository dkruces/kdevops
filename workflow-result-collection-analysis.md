# Workflow Result Collection Gap Analysis

## Critical Gap Discovery

After analyzing the disabled fstests.yml and comparing it with our current modular actions, **we are missing critical workflow-specific result collection logic** that produces the rich commit messages seen in kdevops-results-archive.

## What fstests.yml.disabled Does Right

### Metadata File Management
```bash
# Initial metadata (Line 21-26)
echo "$(basename ${{ github.repository }})" > ci.trigger      # "kdevops"
git log -1 --pretty=format:"%s" > ci.subject                  # Commit subject
echo "not ok" > ci.result                                      # Pessimistic start
echo "Nothing to write home about." > ci.commit_extra         # Default message

# Workflow-specific result collection (Line 66)
find workflows/fstests/results/last-run -name xunit_results.txt -type f -exec cat {} \; > ci.commit_extra || true

# Success detection and final result (Line 67-69)
if ! grep -E "failures, [1-9]|errors, [1-9]" ci.commit_extra; then
  echo "ok" > ci.result
fi
```

## What Our Current Actions Miss

### ❌ **Missing in Test Action:**
1. **Workflow-specific result collection**: No `xunit_results.txt` extraction for fstests
2. **Proper result format**: Generic `.dmesg.log` and `.userspace.log` instead of rich summaries
3. **Workflow-aware success detection**: Simple "fail" grep instead of format-specific parsing

### ❌ **Missing Metadata Handling:**
Our setup action creates metadata files but they're **incomplete**:
- ✅ `ci.trigger` - Has it (kernel tree)
- ❌ `ci.subject` - Missing (should be commit subject, not "testing")
- ✅ `ci.result` - Has it (but wrong values)
- ✅ `ci.commit_extra` - Has it (but wrong content)

## Workflow-Specific Result Collection Patterns

### **1. fstests (XFS, Btrfs, EXT4, tmpfs)**
- **Result File**: `xunit_results.txt` (generated by `gen_results_summary.py`)
- **Success Pattern**: `! grep -E "failures, [1-9]|errors, [1-9]"`
- **Sample Output**:
  ```
  xfs_reflink_4k: 1 tests, 17 seconds
    generic/003  Pass     14s
  Totals: 1 tests, 0 skipped, 0 failures, 0 errors, 14s
  ```

### **2. blktests**
- **Result Files**: Uses `gen-results-dir.py` (no xunit format)
- **Success Pattern**: Need to analyze blktests result format
- **Output Location**: `workflows/blktests/results/`

### **3. selftests (kmod, xarray, maple, sysctl, firmware)**
- **Result Files**: `*.userspace.log` files
- **Success Pattern**: Varies by test type
- **Sample Output**: `XArray: 159585916 of 159585916 tests passed`

## Expected kdevops-results-archive Commit Format

```
kdevops: ci: wip

This adds test results for:
  workflow: fstests
  tree: linux
  ref: linux
  test number: 0007
  test result: ok

Detailed test report:

KERNEL:    6.15.0
CPUS:      8

xfs_reflink_4k: 1 tests, 17 seconds
  generic/003  Pass     14s
Totals: 1 tests, 0 skipped, 0 failures, 0 errors, 14s
```

## Root Cause: Generic vs Workflow-Specific Logic

### **Current Generic Approach (Insufficient):**
```bash
# Our current test action (lines 47-53)
find ${{ steps.setpath.outputs.wpath }}/results/last-run/ -name '*.dmesg.log' \
-exec tail -n 1 {} + >> ci.commit_extra

find ${{ steps.setpath.outputs.wpath }}/results/last-run/ -name '*.userspace.log' \
-exec tail -n 1 {} + >> ci.commit_extra

if grep -i -q "fail" ci.commit_extra ; then
  echo "fail" > ci.result
else
  echo "ok" > ci.result
fi
```

### **Required Workflow-Specific Approach:**
```bash
case "${{ inputs.ci_workflow }}" in
  *fstests*|*xfs*|*btrfs*|*ext4*|tmpfs*)
    # Use xunit_results.txt for rich fstests summary
    find $wpath/results/last-run -name xunit_results.txt -exec cat {} \; > ci.commit_extra
    if ! grep -E "failures, [1-9]|errors, [1-9]" ci.commit_extra; then
      echo "ok" > ci.result
    fi
    ;;
  blktests*)
    # Use blktests-specific result parsing
    # Need to implement blktests result summary extraction
    ;;
  *selftests*|*modules*|*mm*)
    # Use selftests userspace.log parsing
    find $wpath/results/last-run -name "*.userspace.log" -exec cat {} \; > ci.commit_extra
    if grep -q "passed" ci.commit_extra && ! grep -q "FAIL\|failed" ci.commit_extra; then
      echo "ok" > ci.result
    fi
    ;;
esac
```

## Additional Missing Metadata

### **Repository Context (Missing):**
Our setup action uses wrong `ci.subject`:
```bash
echo "testing" > ../ci.subject  # ❌ Should be actual commit subject
```

Should be:
```bash
git log -1 --pretty=format:"%s" > ci.subject  # ✅ Actual commit subject
```

### **Workflow Context (Missing):**
Need to add workflow identification:
```bash
echo "${{ inputs.ci_workflow }}" > ci.workflow
```

## Implementation Gap Summary

### **CRITICAL MISSING PIECES:**

1. **Workflow-Specific Result Collection**:
   - fstests: `xunit_results.txt` extraction
   - blktests: Custom result parsing (TBD)
   - selftests: Better userspace.log parsing

2. **Metadata Corrections**:
   - Fix `ci.subject` to use actual commit subject
   - Add `ci.workflow` for workflow identification
   - Proper result values ("ok"/"not ok" vs "unknown"/"fail")

3. **Success Detection Logic**:
   - fstests: `! grep -E "failures, [1-9]|errors, [1-9]"`
   - blktests: Need to analyze format
   - selftests: Pattern-based success detection

4. **Archive Integration**:
   - Ensure all metadata files are properly passed to `ci-archive`
   - Verify archive playbook uses these files correctly

## Next Steps Required

1. **Fix Setup Action Metadata**:
   - Correct `ci.subject` to use commit subject
   - Add missing metadata fields

2. **Enhance Test Action**:
   - Add workflow-specific result collection switch
   - Implement proper success detection per workflow

3. **Validate Archive Integration**:
   - Ensure archive action processes all metadata correctly
   - Test with each workflow type

4. **Test Result Format Verification**:
   - Verify each workflow produces expected result archive format
   - Match kdevops-results-archive commit structure

This explains why our current modular approach, while architecturally sound, is missing the workflow-specific intelligence that produces the rich, informative commits seen in the kdevops-results-archive repository.